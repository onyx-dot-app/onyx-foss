name: Post-Merge Beta Cherry-Pick

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  cherry-pick-to-latest-release:
    outputs:
      should_cherrypick: ${{ steps.gate.outputs.should_cherrypick }}
      pr_number: ${{ steps.gate.outputs.pr_number }}
      cherry_pick_reason: ${{ steps.run_cherry_pick.outputs.reason }}
      cherry_pick_details: ${{ steps.run_cherry_pick.outputs.details }}
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Resolve merged PR and checkbox state
        id: gate
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # For the commit that triggered this workflow (HEAD on main), fetch all
          # associated PRs and keep only the PR that was actually merged into main
          # with this exact merge commit SHA.
          pr_numbers="$(gh api "repos/${GITHUB_REPOSITORY}/commits/${GITHUB_SHA}/pulls" | jq -r --arg sha "${GITHUB_SHA}" '.[] | select(.merged_at != null and .base.ref == "main" and .merge_commit_sha == $sha) | .number')"
          match_count="$(printf '%s\n' "$pr_numbers" | sed '/^[[:space:]]*$/d' | wc -l | tr -d ' ')"
          pr_number="$(printf '%s\n' "$pr_numbers" | sed '/^[[:space:]]*$/d' | head -n 1)"

          if [ "${match_count}" -gt 1 ]; then
            echo "::warning::Multiple merged PRs matched commit ${GITHUB_SHA}. Using PR #${pr_number}."
          fi

          if [ -z "$pr_number" ]; then
            echo "No merged PR associated with commit ${GITHUB_SHA}; skipping."
            echo "should_cherrypick=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Read the PR once so we can gate behavior and infer preferred actor.
          pr_json="$(gh api "repos/${GITHUB_REPOSITORY}/pulls/${pr_number}")"
          pr_body="$(printf '%s' "$pr_json" | jq -r '.body // ""')"
          merged_by="$(printf '%s' "$pr_json" | jq -r '.merged_by.login // ""')"

          echo "pr_number=$pr_number" >> "$GITHUB_OUTPUT"
          echo "merged_by=$merged_by" >> "$GITHUB_OUTPUT"

          if echo "$pr_body" | grep -qiE "\\[x\\][[:space:]]*(\\[[^]]+\\][[:space:]]*)?Please cherry-pick this PR to the latest release version"; then
            echo "should_cherrypick=true" >> "$GITHUB_OUTPUT"
            echo "Cherry-pick checkbox checked for PR #${pr_number}."
            exit 0
          fi

          echo "should_cherrypick=false" >> "$GITHUB_OUTPUT"
          echo "Cherry-pick checkbox not checked for PR #${pr_number}. Skipping."

      - name: Checkout repository
        if: steps.gate.outputs.should_cherrypick == 'true'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: true
          ref: main

      - name: Install the latest version of uv
        if: steps.gate.outputs.should_cherrypick == 'true'
        uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # ratchet:astral-sh/setup-uv@v7
        with:
          enable-cache: false
          version: "0.9.9"

      - name: Configure git identity
        if: steps.gate.outputs.should_cherrypick == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create cherry-pick PR to latest release
        id: run_cherry_pick
        if: steps.gate.outputs.should_cherrypick == 'true'
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_TOKEN: ${{ github.token }}
          CHERRY_PICK_ASSIGNEE: ${{ steps.gate.outputs.merged_by }}
        run: |
          set -o pipefail
          output_file="$(mktemp)"
          uv run --no-sync --with onyx-devtools ods cherry-pick "${GITHUB_SHA}" --yes --no-verify 2>&1 | tee "$output_file"
          exit_code="${PIPESTATUS[0]}"

          if [ "${exit_code}" -eq 0 ]; then
            echo "status=success" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "status=failure" >> "$GITHUB_OUTPUT"

          reason="command-failed"
          if grep -qiE "merge conflict during cherry-pick|CONFLICT|could not apply|cherry-pick in progress with staged changes" "$output_file"; then
            reason="merge-conflict"
          fi
          echo "reason=${reason}" >> "$GITHUB_OUTPUT"

          {
            echo "details<<EOF"
            tail -n 40 "$output_file"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Mark workflow as failed if cherry-pick failed
        if: steps.gate.outputs.should_cherrypick == 'true' && steps.run_cherry_pick.outputs.status == 'failure'
        env:
          CHERRY_PICK_REASON: ${{ steps.run_cherry_pick.outputs.reason }}
        run: |
          echo "::error::Automated cherry-pick failed (${CHERRY_PICK_REASON})."
          exit 1

  notify-slack-on-cherry-pick-failure:
    needs:
      - cherry-pick-to-latest-release
    if: always() && needs.cherry-pick-to-latest-release.outputs.should_cherrypick == 'true' && needs.cherry-pick-to-latest-release.result != 'success'
    runs-on: ubuntu-slim
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v6
        with:
          persist-credentials: false

      - name: Build cherry-pick failure summary
        id: failure-summary
        env:
          SOURCE_PR_NUMBER: ${{ needs.cherry-pick-to-latest-release.outputs.pr_number }}
          CHERRY_PICK_REASON: ${{ needs.cherry-pick-to-latest-release.outputs.cherry_pick_reason }}
          CHERRY_PICK_DETAILS: ${{ needs.cherry-pick-to-latest-release.outputs.cherry_pick_details }}
        run: |
          source_pr_url="https://github.com/${GITHUB_REPOSITORY}/pull/${SOURCE_PR_NUMBER}"

          reason_text="cherry-pick command failed"
          if [ "${CHERRY_PICK_REASON}" = "merge-conflict" ]; then
            reason_text="merge conflict during cherry-pick"
          fi

          details_excerpt="$(printf '%s' "${CHERRY_PICK_DETAILS}" | tail -n 8 | tr '\n' ' ' | sed "s/[[:space:]]\\+/ /g" | sed "s/\"/'/g" | cut -c1-350)"
          failed_jobs="â€¢ cherry-pick-to-latest-release\\nâ€¢ source PR: ${source_pr_url}\\nâ€¢ reason: ${reason_text}"
          if [ -n "${details_excerpt}" ]; then
            failed_jobs="${failed_jobs}\\nâ€¢ excerpt: ${details_excerpt}"
          fi

          echo "jobs=${failed_jobs}" >> "$GITHUB_OUTPUT"

      - name: Notify #cherry-pick-prs about cherry-pick failure
        uses: ./.github/actions/slack-notify
        with:
          webhook-url: ${{ secrets.CHERRY_PICK_PRS_WEBHOOK }}
          failed-jobs: ${{ steps.failure-summary.outputs.jobs }}
          title: "ðŸš¨ Automated Cherry-Pick Failed"
          ref-name: ${{ github.ref_name }}
