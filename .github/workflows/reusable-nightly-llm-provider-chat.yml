name: Reusable Nightly LLM Provider Chat Tests

on:
  workflow_call:
    inputs:
      openai_models:
        description: "Comma-separated models for openai"
        required: false
        default: ""
        type: string
      anthropic_models:
        description: "Comma-separated models for anthropic"
        required: false
        default: ""
        type: string
      bedrock_models:
        description: "Comma-separated models for bedrock"
        required: false
        default: ""
        type: string
      vertex_ai_models:
        description: "Comma-separated models for vertex_ai"
        required: false
        default: ""
        type: string
      azure_models:
        description: "Comma-separated models for azure"
        required: false
        default: ""
        type: string
      azure_api_base:
        description: "API base for azure provider"
        required: false
        default: ""
        type: string
      strict:
        description: "Default NIGHTLY_LLM_STRICT passed to tests"
        required: false
        default: true
        type: boolean
    secrets:
      openai_api_key:
        required: false
      anthropic_api_key:
        required: false
      bedrock_api_key:
        required: false
      vertex_ai_custom_config_json:
        required: false
      azure_api_key:
        required: false
      DOCKER_USERNAME:
        required: true
      DOCKER_TOKEN:
        required: true

permissions:
  contents: read

jobs:
  build-backend-image:
    runs-on:
      [
        runs-on,
        runner=1cpu-linux-arm64,
        "run-id=${{ github.run_id }}-build-backend-image",
        "extras=ecr-cache",
      ]
    timeout-minutes: 45
    steps:
      - uses: runs-on/action@cd2b598b0515d39d78c38a02d529db87d2196d1e # ratchet:runs-on/action@v2

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v6
        with:
          persist-credentials: false

      - name: Build backend image
        uses: ./.github/actions/build-backend-image
        with:
          runs-on-ecr-cache: ${{ env.RUNS_ON_ECR_CACHE }}
          ref-name: ${{ github.ref_name }}
          pr-number: ${{ github.event.pull_request.number }}
          github-sha: ${{ github.sha }}
          run-id: ${{ github.run_id }}
          docker-username: ${{ secrets.DOCKER_USERNAME }}
          docker-token: ${{ secrets.DOCKER_TOKEN }}
          docker-no-cache: ${{ vars.DOCKER_NO_CACHE == 'true' && 'true' || 'false' }}

  build-model-server-image:
    runs-on:
      [
        runs-on,
        runner=1cpu-linux-arm64,
        "run-id=${{ github.run_id }}-build-model-server-image",
        "extras=ecr-cache",
      ]
    timeout-minutes: 45
    steps:
      - uses: runs-on/action@cd2b598b0515d39d78c38a02d529db87d2196d1e # ratchet:runs-on/action@v2

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v6
        with:
          persist-credentials: false

      - name: Build model server image
        uses: ./.github/actions/build-model-server-image
        with:
          runs-on-ecr-cache: ${{ env.RUNS_ON_ECR_CACHE }}
          ref-name: ${{ github.ref_name }}
          pr-number: ${{ github.event.pull_request.number }}
          github-sha: ${{ github.sha }}
          run-id: ${{ github.run_id }}
          docker-username: ${{ secrets.DOCKER_USERNAME }}
          docker-token: ${{ secrets.DOCKER_TOKEN }}

  build-integration-image:
    runs-on:
      [
        runs-on,
        runner=2cpu-linux-arm64,
        "run-id=${{ github.run_id }}-build-integration-image",
        "extras=ecr-cache",
      ]
    timeout-minutes: 45
    steps:
      - uses: runs-on/action@cd2b598b0515d39d78c38a02d529db87d2196d1e # ratchet:runs-on/action@v2

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v6
        with:
          persist-credentials: false

      - name: Build integration image
        uses: ./.github/actions/build-integration-image
        with:
          runs-on-ecr-cache: ${{ env.RUNS_ON_ECR_CACHE }}
          ref-name: ${{ github.ref_name }}
          pr-number: ${{ github.event.pull_request.number }}
          github-sha: ${{ github.sha }}
          run-id: ${{ github.run_id }}
          docker-username: ${{ secrets.DOCKER_USERNAME }}
          docker-token: ${{ secrets.DOCKER_TOKEN }}

  provider-chat-test:
    needs:
      [
        build-backend-image,
        build-model-server-image,
        build-integration-image,
      ]
    strategy:
      fail-fast: false
      matrix:
        include:
          - provider: openai
            models: ${{ inputs.openai_models }}
            api_key_secret: openai_api_key
            custom_config_secret: ""
            api_base: ""
            api_version: ""
            deployment_name: ""
            required: true
          - provider: anthropic
            models: ${{ inputs.anthropic_models }}
            api_key_secret: anthropic_api_key
            custom_config_secret: ""
            api_base: ""
            api_version: ""
            deployment_name: ""
            required: true
          - provider: bedrock
            models: ${{ inputs.bedrock_models }}
            api_key_secret: bedrock_api_key
            custom_config_secret: ""
            api_base: ""
            api_version: ""
            deployment_name: ""
            required: false
          - provider: vertex_ai
            models: ${{ inputs.vertex_ai_models }}
            api_key_secret: ""
            custom_config_secret: vertex_ai_custom_config_json
            api_base: ""
            api_version: ""
            deployment_name: ""
            required: false
          - provider: azure
            models: ${{ inputs.azure_models }}
            api_key_secret: azure_api_key
            custom_config_secret: ""
            api_base: ${{ inputs.azure_api_base }}
            api_version: "2025-04-01-preview"
            deployment_name: ""
            required: false
    runs-on:
      - runs-on
      - runner=4cpu-linux-arm64
      - "run-id=${{ github.run_id }}-nightly-${{ matrix.provider }}-provider-chat-test"
      - extras=ecr-cache
    timeout-minutes: 45
    steps:
      - uses: runs-on/action@cd2b598b0515d39d78c38a02d529db87d2196d1e # ratchet:runs-on/action@v2

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v6
        with:
          persist-credentials: false

      - name: Run nightly provider chat test
        uses: ./.github/actions/run-nightly-provider-chat-test
        with:
          provider: ${{ matrix.provider }}
          models: ${{ matrix.models }}
          provider-api-key: ${{ matrix.api_key_secret && secrets[matrix.api_key_secret] || '' }}
          strict: ${{ inputs.strict && 'true' || 'false' }}
          api-base: ${{ matrix.api_base }}
          api-version: ${{ matrix.api_version }}
          deployment-name: ${{ matrix.deployment_name }}
          custom-config-json: ${{ matrix.custom_config_secret && secrets[matrix.custom_config_secret] || '' }}
          runs-on-ecr-cache: ${{ env.RUNS_ON_ECR_CACHE }}
          run-id: ${{ github.run_id }}
          docker-username: ${{ secrets.DOCKER_USERNAME }}
          docker-token: ${{ secrets.DOCKER_TOKEN }}

      - name: Dump API server logs
        if: always()
        run: |
          cd deployment/docker_compose
          docker compose logs --no-color api_server > $GITHUB_WORKSPACE/api_server.log || true

      - name: Dump all-container logs
        if: always()
        run: |
          cd deployment/docker_compose
          docker compose logs --no-color > $GITHUB_WORKSPACE/docker-compose.log || true

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: docker-all-logs-nightly-${{ matrix.provider }}-llm-provider
          path: |
            ${{ github.workspace }}/api_server.log
            ${{ github.workspace }}/docker-compose.log

      - name: Stop Docker containers
        if: always()
        run: |
          cd deployment/docker_compose
          docker compose down -v
